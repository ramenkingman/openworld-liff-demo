<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OpenWorld 会員証</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>OpenWorld 会員証</h1>
  <img id="profileImg" width="100" />
  <p id="name">ユーザー名: </p>
  <p id="userId">ユーザーID: </p>
  <p id="serial">会員番号: </p>
  <p id="timestamp">登録日時: </p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwqG7to68d7O9KQ2EPWaUD1UFm_Cq9HXo",
      authDomain: "openworld-liff.firebaseapp.com",
      projectId: "openworld-liff",
      storageBucket: "openworld-liff.firebasestorage.app",
      messagingSenderId: "79997022356",
      appId: "1:79997022356:web:89e7081d808bc5fc418481",
      measurementId: "G-SRK6BVFDYN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function main() {
      await liff.init({ liffId: "2007741116-ljZP4eGp" });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const userId = profile.userId;

      const membersRef = collection(db, "members");
      const q = query(membersRef, where("userId", "==", userId));
      const existing = await getDocs(q);

      let data;
      if (existing.empty) {
        const all = await getDocs(query(membersRef, orderBy("createdAt")));
        const serialNumber = all.size + 1;
        const createdAt = new Date();

        const docRef = await addDoc(membersRef, {
          userId: userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl,
          createdAt: createdAt,
          serialNumber: serialNumber
        });

        data = {
          userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl,
          createdAt,
          serialNumber
        };
      } else {
        data = existing.docs[0].data();
      }

      document.getElementById("profileImg").src = data.pictureUrl;
      document.getElementById("name").innerText = "ユーザー名: " + data.displayName;
      document.getElementById("userId").innerText = "ユーザーID: " + data.userId;
      document.getElementById("serial").innerText = "会員番号: #" + String(data.serialNumber).padStart(4, "0");
      document.getElementById("timestamp").innerText = "登録日時: " + new Date(data.createdAt.seconds ? data.createdAt.seconds * 1000 : data.createdAt).toLocaleString();
    }

    main();
  </script>
</body>
</html>