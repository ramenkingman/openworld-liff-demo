<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OpenWorld ä¼šå“¡è¨¼</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwqG7to68d7O9KQ2EPWaUD1UFm_Cq9HXo",
      authDomain: "openworld-liff.firebaseapp.com",
      projectId: "openworld-liff",
      storageBucket: "openworld-liff.firebasestorage.app",
      messagingSenderId: "79997022356",
      appId: "1:79997022356:web:89e7081d808bc5fc418481",
      measurementId: "G-SRK6BVFDYN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function main() {
      await liff.init({ liffId: "2007741116-ljZP4eGp" });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const userId = profile.userId;

      // ğŸ” ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã‹ç¢ºèª
      const q = query(collection(db, "members"), where("userId", "==", userId));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        await addDoc(collection(db, "members"), {
          userId: userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl,
          registeredAt: new Date()
        });
      }

      // ğŸ”„ ç™»éŒ²é †ã‚’å–å¾—
      const allDocs = await getDocs(query(collection(db, "members"), orderBy("registeredAt")));
      let serialNumber = null;
      let registeredAt = null;

      allDocs.forEach((doc, index) => {
        const data = doc.data();
        if (data.userId?.trim() === userId.trim()) {
          serialNumber = index + 1;
          registeredAt = data.registeredAt;
        }
      });

      // âœ… NaNå¯¾ç­–ï¼ˆ1ä»¶ã—ã‹ãªã„å ´åˆãªã©ï¼‰
      if (!serialNumber && allDocs.size === 1) {
        serialNumber = 1;
        registeredAt = allDocs.docs[0].data().registeredAt;
      }

      // âŒ ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰
      if (!serialNumber) {
        document.getElementById("serial").innerText = "ä¼šå“¡è¨¼ No: ä¸æ˜";
        document.getElementById("name").innerText = `åå‰: ${profile.displayName}`;
        document.getElementById("userId").innerText = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`;
        document.getElementById("timestamp").innerText = `ç™»éŒ²æ—¥æ™‚: ä¸æ˜`;
        document.getElementById("profileImg").src = profile.pictureUrl;
        return;
      }

      // âœ… è¡¨ç¤ºåæ˜ 
      document.getElementById("serial").innerText = `ä¼šå“¡è¨¼ No: #${String(serialNumber).padStart(4, "0")}`;
      document.getElementById("name").innerText = `åå‰: ${profile.displayName}`;
      document.getElementById("userId").innerText = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`;
      document.getElementById("timestamp").innerText = `ç™»éŒ²æ—¥æ™‚: ${new Date(registeredAt).toLocaleString()}`;
      document.getElementById("profileImg").src = profile.pictureUrl;
    }

    main();
  </script>
</head>
<body>
  <h1>OpenWorld ä¼šå“¡è¨¼</h1>
  <p id="serial">ä¼šå“¡è¨¼ No: å–å¾—ä¸­...</p>
  <p id="name">åå‰: å–å¾—ä¸­...</p>
  <p id="userId">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: å–å¾—ä¸­...</p>
  <p id="timestamp">ç™»éŒ²æ—¥æ™‚: å–å¾—ä¸­...</p>
  <img id="profileImg" style="width: 150px; border-radius: 50%;" />
</body>
</html>
