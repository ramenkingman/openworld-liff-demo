<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OpenWorld 会員証</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script type="module">
    // Firebase SDKのインポート
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwqG7ot6d8d70gKQ2EPWAuD1UFm_Cq9HXo",
      authDomain: "openworld-liff.firebaseapp.com",
      projectId: "openworld-liff",
      storageBucket: "openworld-liff.appspot.com",
      messagingSenderId: "79997022356",
      appId: "1:79997022356:web:98e70d18d80b85cfc418481",
      measurementId: "G-SRK6BVFDYN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function main() {
      await liff.init({ liffId: "2007741116-ljZP4eGp" });

      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        const profile = await liff.getProfile();
        const userId = profile.userId;
        const name = profile.displayName;

        // Firestoreに既に登録済みか確認
        const usersRef = collection(db, "members");
        const q = query(usersRef, where("userId", "==", userId));
        const snapshot = await getDocs(q);

        let serial, createdAt;

        if (snapshot.empty) {
          // 新規登録 → シリアル番号は件数 + 1
          const allUsersSnap = await getDocs(query(usersRef, orderBy("timestamp")));
          serial = allUsersSnap.size + 1;
          createdAt = new Date().toISOString();

          await addDoc(usersRef, {
            userId,
            displayName: name,
            timestamp: createdAt,
            serial
          });
        } else {
          const data = snapshot.docs[0].data();
          serial = data.serial;
          createdAt = data.timestamp;
        }

        // HTMLに反映
        document.getElementById("name").innerText = `ユーザー名: ${name}`;
        document.getElementById("userId").innerText = `ユーザーID: ${userId}`;
        document.getElementById("serial").innerText = `シリアル番号: #${String(serial).padStart(5, "0")}`;
        document.getElementById("timestamp").innerText = `登録日時: ${createdAt}`;
      }
    }

    main();
  </script>
</head>
<body>
  <h1>OpenWorld 会員証</h1>
  <p id="name">ユーザー名: 取得中...</p>
  <p id="userId">ユーザーID: </p>
  <p id="serial">シリアル番号: </p>
  <p id="timestamp">登録日時: </p>
</body>
</html>